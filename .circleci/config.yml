version: 2.1
orbs:
  cypress: cypress-io/cypress@3.1.3

executors:
  with-chrome-and-firefox:
    docker:
      - image: "cypress/browsers:node-16.18.1-chrome-110.0.5481.96-1-ff-109.0-edge-110.0.1587.41-1"
    resource_class: xlarge
    environment:
      CYPRESS_coverage: false

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Commands ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
commands:
  report-coverage:
    description: |
      Store coverage report as an artifact and send it to Codecov service.
    steps:
      - store_artifacts:
          path: tests/e2e/screenshots
      - run: npx nyc report --reporter=text || true
  persist_ws:
    steps:
      - persist_to_workspace:
          paths:
            # for linux builds
            - .cache/Cypress
            - project
          root: ~/
  attach_ws:
    steps:
      - attach_workspace:
          at: ~/

  # Setup
  #  1. Install Cypress
  #  2. Validate types
  #  3. Run server unit-tests
  setup_project_and_cypress:
    steps:
      - cypress/install:
          package-manager: npm
      - run:
          name: Build CI ℹ️
          command: npm run build-bundle
      - run:
          name: Print machine info ℹ️
          command: npx cypress info
      - run:
          name: Cypress cache list
          command: npx cypress cache list
      - run:
          name: Lint Files
          command: npm run lint
      - run:
          name: Run Unit Tests
          command: npm run test-unit
      - persist_ws
  cypress_tests:
    parameters:
      browser:
        type: string
        default: chrome
      specPattern:
        type: string
        default: ''
      ciBuildId:
        type: string
      group:
        type: string
    steps:
      - attach_ws
      - cypress/run-tests:
          cypress-command: TZ=UTC npx vue-cli-service test:e2e --mode test --headless --ci-build-id=<<parameters.ciBuildId>> --group="<<parameters.group>>" --record --key $CYPRESS_RECORD_KEY --parallel --spec=<<parameters.specPattern>> --browser=<<parameters.browser>>
      - report-coverage

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Jobs ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
jobs:
  setup_project_and_cypress_linux:
    executor: with-chrome-and-firefox
    steps:
      - setup_project_and_cypress
  cypress_tests_linux:
    executor: with-chrome-and-firefox
    parallelism: 5
    parameters:
      browser:
        type: string
        default: chrome
      specPattern:
        type: string
        default: ''
      ciBuildId:
        type: string
      group:
        type: string
    steps:
      - cypress_tests:
          browser: <<parameters.browser>>
          specPattern: <<parameters.specPattern>>
          ciBuildId: <<parameters.ciBuildId>>
          group: <<parameters.group>>

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Workflows ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
linux-workflow: &linux-workflow
  jobs:
    - setup_project_and_cypress_linux:
        name: "Setup Linux"
    # Run E2E tests in Chrome
    - cypress_tests_linux:
        name: "UI Tests - Chrome"
        browser: chrome
        specPattern: "tests/e2e/**/*"
        ciBuildId: ${CIRCLE_SHA1:0:8}
        group: "UI - Chrome"
        requires:
          - Setup Linux
workflows:
  linux:
    <<: *linux-workflow
